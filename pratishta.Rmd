---
title: "NYC Sanitation and Rat Sightings "
author: "Pratishta Yerakala"
date: "4/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Download all necessary libraries 
library(ggplot2)    # the king of plotting 
library(magrittr)   # chain operators, e.g. to "pipe" a value forward
library(plyr)
library(dplyr) 
library(tidyverse)
library(DT)
library(knitr)
library(maps)
library(rgdal)
library(ggmap)
library(tmap)
library(sp)
```


```{r, layout="l-body-outset"}
# read in the main csv file
rat_data<-read.csv("sanitation_data/rat_data.csv")

rat_data <- rat_data %>%
  mutate(Borough = str_to_title(rat_data$Borough))

tonnage_data<-read.csv("sanitation_data/dsny_boro_tonnage.csv", stringsAsFactors = FALSE)


head(rat_data)
head(tonnage_data)
```

converting tonnage month to date data

```{r}
ton_date <- tonnage_data %>%
  mutate(MONTH = paste(MONTH, " / 01")) %>% 
  mutate(MONTH = as.Date(MONTH, format = '%Y / %m / %d')) %>%
  filter(MONTH > as.Date('2020-01-01', '%Y-%m-%d'), MONTH < as.Date('2021-03-01', '%Y-%m-%d')) %>% 
  arrange(desc(MONTH))

ton_date
```
converting and grouping rat data by month and borough

```{r}
rat_date <- rat_data %>% 
  mutate(Created.Date = as.Date(Created.Date, "%m/%d/%Y")) %>%
  mutate(Created.Date = as.character(Created.Date)) %>%
  mutate(Created.Date = substr(Created.Date, 1, 8)) %>%
  mutate(Created.Date = paste(Created.Date, '01')) %>%
  mutate(Created.Date = as.Date(Created.Date, "%Y-%m-%d")) %>%
  group_by(Created.Date, Borough) %>%
  tally() %>%
  filter(Created.Date > as.Date('2020-01-01', '%Y-%m-%d'), Created.Date < as.Date('2021-03-01', '%Y-%m-%d')) %>% 
  arrange(desc(Created.Date))

rat_date
```
```{r}
rat_ton_date <- merge(rat_date, ton_date, by.x = c("Created.Date", "Borough"), by.y = c("MONTH", "BOROUGH")) %>%
  mutate(rate = n / (REFUSETONSCOLLECTED / 100))

rat_ton_date
```
```{r}
p <- ggplot(rat_ton_date, aes(x=Created.Date, y=REFUSETONSCOLLECTED)) +
  geom_line(aes(color = Borough)) +
  geom_point(aes(color = Borough)) +
  xlab("Date by Months") + 
  ylab("Weight of Waste (Tons)")

p
```

```{r}
p <- ggplot(rat_ton_date, aes(x=Created.Date, y=n)) +
  geom_line(aes(color = Borough)) +
  geom_point(aes(color = Borough)) +
  xlab("Date by Months") + 
  ylab("Number of rat sightings")

p
```

```{r}
p <- ggplot(rat_ton_date, aes(x=Created.Date, y=rate)) +
  geom_line(aes(color = Borough)) +
  geom_point(aes(color = Borough)) +
  xlab("Date by Months") + 
  ylab("Rate of rats per kiloton of waste")

p
```














```{r}
full_tonnage <-read.csv("sanitation_data/dsny_full_tonnage.csv", stringsAsFactors = FALSE)
full_tonnage <- full_tonnage %>%
  mutate(district =  paste(full_tonnage$COMMUNITYDISTRICT, " ", str_to_upper(full_tonnage$BOROUGH)))
      
```
```{r}
head(full_tonnage)
```
```{r}
# ton_col <- unique(full_tonnage[c("district")]) 
# ratcol <- unique(rat_data[c("Community.Board")]) %>%
```


```{r}
rat_borough <- rat_data %>% 
  group_by(Borough) %>%
  tally()

rat_borough
```


```{r}
ton_boro <- tonnage_data %>%
  group_by(BOROUGH) %>%
  summarise(total_ton = sum(REFUSETONSCOLLECTED))

ton_boro
```

```{r}
rat_ton <- left_join(rat_borough, ton_boro, by = c("Borough" = "BOROUGH"))
```
```{r}
rat <- ggplot(rat_ton, aes(y=n, x=Borough)) + 
    geom_bar(position="dodge", stat="identity")
rat
```
```{r}
ton <- ggplot(rat_ton, aes(y=total_ton, x=Borough)) + 
    geom_bar(position="dodge", stat="identity")
ton
```

```{r}
# dual y axis 

# A few constants
temperatureColor <- "#69b3a2"
priceColor <- rgb(0.2, 0.6, 0.9, 1)

f <- ggplot(rat_ton, aes(x=Borough)) +
  
  geom_bar( aes(y=n), stat='identity', fill=temperatureColor) + 
  geom_bar( aes(y=total_ton), stat='identity', fill=priceColor) +
  
  scale_y_continuous(
    
    # Features of the first axis
    name = "Number of Rat Sightings",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~ . + 10000000000000000, name="Metric Ton of Waste ")
  ) + 
  
  # theme_ipsum() +

  theme(
    axis.title.y = element_text(color = temperatureColor, size=13),
    axis.title.y.right = element_text(color = priceColor, size=13)
  ) +

  ggtitle("Rat Sightings and Sanitation Waste (Feb 2020 - Feb 2021)")
```

```{r}
f
```

















```{r}
nyc <- readOGR("sanitation_data/DSNYSections/.", "geo_export_c0459e49-70dc-4fa8-a3fc-c3d366dedd05")
```
```{r}
nyc_sp <- spTransform(nyc, CRS("+proj=longlat +datum=WGS84"))
```
```{r}
# nyc_sp@data %>% 
#   filter(nyc_sp@data$district == 'BX0)

```
```{r}
# tm_shape(nyc_sp) +
# tm_fill("section", title = "Number of Tickets")
```
```{r}
plot(nyc_sp)
```

